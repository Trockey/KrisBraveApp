@page "/profile"
@rendermode InteractiveServer
@using DeveloperGoals.DTOs
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Configuration
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Profile> Logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IConfiguration Configuration

<PageTitle>Profil - DeveloperGoals</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <h1 class="mb-4">
                <span class="bi bi-person-fill" aria-hidden="true"></span>
                Mój Profil
            </h1>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <span class="bi bi-check-circle" aria-hidden="true"></span>
                    @successMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @if (validationErrors.Any())
            {
                <div class="alert alert-danger" role="alert">
                    <h6 class="alert-heading">
                        <span class="bi bi-exclamation-triangle" aria-hidden="true"></span>
                        Wystąpiły błędy walidacji:
                    </h6>
                    <ul class="mb-0">
                        @foreach (var error in validationErrors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                </div>
            }

            <div class="card">
                <div class="card-body">
                    <EditForm Model="@profileData" OnValidSubmit="@HandleSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">Główne technologie *</label>
                            <p class="text-muted small mb-2">Wybierz minimum @minTechnologies technologii, które znasz</p>
                            
                            @if (selectedTechnologies.Count < minTechnologies && selectedTechnologies.Count > 0)
                            {
                                <div class="alert alert-warning mb-2" role="alert">
                                    <small>
                                        <span class="bi bi-exclamation-triangle" aria-hidden="true"></span>
                                        Wybrano @selectedTechnologies.Count z minimum @minTechnologies wymaganych technologii
                                    </small>
                                </div>
                            }
                            
                            <div class="row">
                                <div class="col-md-6">
                                    @foreach (var tech in availableTechnologies.Take(5))
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="@($"tech-{tech.Key}")"
                                                   checked="@tech.Value"
                                                   @onchange="@((e) => ToggleTechnology(tech.Key, (bool)e.Value!))">
                                            <label class="form-check-label" for="@($"tech-{tech.Key}")">@tech.Key</label>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-6">
                                    @foreach (var tech in availableTechnologies.Skip(5))
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="@($"tech-{tech.Key}")"
                                                   checked="@tech.Value"
                                                   @onchange="@((e) => ToggleTechnology(tech.Key, (bool)e.Value!))">
                                            <label class="form-check-label" for="@($"tech-{tech.Key}")">@tech.Key</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="role" class="form-label fw-bold">Rola *</label>
                            <select class="form-select @(string.IsNullOrEmpty(profileData.Role) && hasSubmitted ? "is-invalid" : "")" 
                                    id="role"
                                    @bind="profileData.Role">
                                <option value="">Wybierz rolę...</option>
                                <option value="Programista">Programista</option>
                                <option value="Tester">Tester</option>
                                <option value="Analityk">Analityk</option>
                                <option value="DataScienceSpecialist">Data Science Specialist</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="area" class="form-label fw-bold">Obszar rozwoju *</label>
                            <select class="form-select @(string.IsNullOrEmpty(profileData.DevelopmentArea) && hasSubmitted ? "is-invalid" : "")" 
                                    id="area"
                                    @bind="profileData.DevelopmentArea">
                                <option value="">Wybierz obszar...</option>
                                <option value="UserInterface">User Interface</option>
                                <option value="Backend">Backend</option>
                                <option value="FullStack">Full Stack</option>
                                <option value="Testing">Testing</option>
                                <option value="DataScience">Data Science</option>
                                <option value="DevOps">DevOps</option>
                            </select>
                        </div>

                        <div class="alert alert-warning" role="alert">
                            <small>
                                <span class="bi bi-exclamation-triangle" aria-hidden="true"></span>
                                Wszystkie pola są wymagane. Zmiana profilu NIE powoduje automatycznej regeneracji grafu technologii.
                            </small>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" @onclick="@HandleCancel">
                                Anuluj
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@(isSaving)">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Zapisywanie...</span>
                                }
                                else
                                {
                                    <span class="bi bi-check-circle" aria-hidden="true"></span>
                                    <span>Zapisz profil</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>

            <div class="mt-3">
                <p class="text-muted small">
                    <span class="bi bi-info-circle" aria-hidden="true"></span>
                    Czas wypełnienia profilu: około 3 minuty
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    private CreateProfileCommand profileData = new();
    private Dictionary<string, bool> availableTechnologies = new()
    {
        { ".NET / C#", false },
        { "Java", false },
        { "JavaScript", false },
        { "TypeScript", false },
        { "Python", false },
        { "React", false },
        { "Angular", false },
        { "Vue.js", false },
        { "SQL", false },
        { "Docker", false }
    };
    
    private List<string> selectedTechnologies = new();
    private List<string> validationErrors = new();
    private string? successMessage;
    private bool isSaving = false;
    private bool hasSubmitted = false;
    private bool isUpdateMode = false;
    private int minTechnologies = 2;
    private string email = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Pobierz minimalną liczbę technologii z konfiguracji
        minTechnologies = Configuration.GetValue<int>("Profile:MinTechnologies", 2);
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            email = user.FindFirst(ClaimTypes.Email)?.Value ?? string.Empty;
            
            // Spróbuj pobrać istniejący profil
            var response = await Http.GetAsync($"/api/profile?email={email}");
            if (response.IsSuccessStatusCode)
            {
                var existingProfile = await response.Content.ReadFromJsonAsync<UserProfileDto>();
                if (existingProfile != null)
                {
                    isUpdateMode = true;
                    profileData.Role = existingProfile.Role;
                    profileData.DevelopmentArea = existingProfile.DevelopmentArea;
                    
                    // Zaznacz technologie z profilu
                    foreach (var tech in existingProfile.MainTechnologies)
                    {
                        if (availableTechnologies.ContainsKey(tech))
                        {
                            availableTechnologies[tech] = true;
                            if (!selectedTechnologies.Contains(tech))
                            {
                                selectedTechnologies.Add(tech);
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Nie udało się pobrać profilu użytkownika");
            // Jeśli profil nie istnieje, kontynuuj w trybie tworzenia
        }
    }

    private void ToggleTechnology(string technology, bool isChecked)
    {
        availableTechnologies[technology] = isChecked;
        
        if (isChecked && !selectedTechnologies.Contains(technology))
        {
            selectedTechnologies.Add(technology);
        }
        else if (!isChecked)
        {
            selectedTechnologies.Remove(technology);
        }
    }

    private async Task HandleSubmit()
    {
        hasSubmitted = true;
        validationErrors.Clear();
        successMessage = null;

        // Walidacja lokalna
        if (string.IsNullOrWhiteSpace(profileData.Role))
        {
            validationErrors.Add("Rola jest wymagana");
        }

        if (selectedTechnologies.Count < minTechnologies)
        {
            validationErrors.Add($"Musisz wybrać minimum {minTechnologies} technologii");
        }

        if (string.IsNullOrWhiteSpace(profileData.DevelopmentArea))
        {
            validationErrors.Add("Obszar rozwoju jest wymagany");
        }

        if (validationErrors.Any())
        {
            return;
        }

        // Przygotuj dane do wysłania
        profileData.MainTechnologies = selectedTechnologies.ToList();

        isSaving = true;
        try
        {
            HttpResponseMessage response;
            
            if (isUpdateMode)
            {
                // Aktualizuj profil
                var updateCommand = new UpdateProfileCommand
                {
                    MainTechnologies = profileData.MainTechnologies,
                    Role = profileData.Role,
                    DevelopmentArea = profileData.DevelopmentArea,
                    Email = email
                };
                
                response = await Http.PutAsJsonAsync("/api/profile", updateCommand);
            }
            else
            {
                // Utwórz profil
                profileData.Email = email;
                response = await Http.PostAsJsonAsync("/api/profile", profileData);
            }

            if (response.IsSuccessStatusCode)
            {
                successMessage = isUpdateMode 
                    ? "Profil został zaktualizowany pomyślnie!" 
                    : "Profil został utworzony pomyślnie!";
                
                isUpdateMode = true;
                
                // Opcjonalnie: przekieruj po 2 sekundach
                // await Task.Delay(2000);
                // Navigation.NavigateTo("/");
            }
            else
            {
                var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponseDto>();
                if (errorResponse?.Errors != null && errorResponse.Errors.Any())
                {
                    validationErrors.AddRange(errorResponse.Errors.Select(e => e.Message));
                }
                else
                {
                    validationErrors.Add(errorResponse?.Message ?? "Wystąpił błąd podczas zapisywania profilu");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Błąd podczas zapisywania profilu");
            validationErrors.Add("Wystąpił nieoczekiwany błąd. Spróbuj ponownie.");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/");
    }
}

