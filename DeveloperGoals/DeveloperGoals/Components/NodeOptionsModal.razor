@using DeveloperGoals.DTOs
@using DeveloperGoals.Services
@inject ITechnologyService TechnologyService
@inject ILogger<NodeOptionsModal> Logger

@if (IsVisible && Node is not null)
{
    <!-- Modal Overlay -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center p-4"
         @onclick="HandleOverlayClick">
        
        <!-- Modal Content -->
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
             @onclick:stopPropagation="true">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: @GetNodeColor(Node.Progress);"></div>
                    <h3 class="text-2xl font-bold text-gray-900">@Node.Name</h3>
                </div>
                <button type="button" 
                        @onclick="HandleClose"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="bi bi-x-lg text-2xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <!-- Node Info -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <span class="text-sm text-gray-500 block mb-1">Kategoria</span>
                        <p class="font-medium text-gray-900">@Node.Prefix</p>
                    </div>
                    <div>
                        <span class="text-sm text-gray-500 block mb-1">Tag</span>
                        <p class="font-medium text-gray-900">@Node.Tag</p>
                    </div>
                </div>

                <!-- System Description -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Opis systemu</label>
                    <p class="text-gray-600 text-sm bg-gray-50 p-3 rounded-lg">@Node.SystemDescription</p>
                </div>

                <!-- Progress Slider -->
                @if (!Node.IsStart)
                {
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Postęp: <span class="font-bold text-primary-600">@progress%</span>
                        </label>
                        <input type="range" 
                               min="0" 
                               max="100" 
                               step="5"
                               @bind="progress"
                               @bind:event="oninput"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary-600">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0%</span>
                            <span>25%</span>
                            <span>50%</span>
                            <span>75%</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <!-- Private Description -->
                    <div class="mb-6">
                        <label for="privateDesc" class="block text-sm font-medium text-gray-700 mb-2">
                            Twoje notatki (prywatne)
                        </label>
                        <textarea id="privateDesc"
                                  @bind="privateDescription"
                                  rows="4"
                                  placeholder="Dodaj własne notatki, zasoby do nauki, projekty..."
                                  class="w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                }

                <!-- Error Message -->
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="mb-4 p-3 text-red-800 border border-red-300 rounded-lg bg-red-50 text-sm" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        @errorMessage
                    </div>
                }

                <!-- Success Message -->
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="mb-4 p-3 text-green-800 border border-green-300 rounded-lg bg-green-50 text-sm" role="alert">
                        <i class="bi bi-check-circle"></i>
                        @successMessage
                    </div>
                }
            </div>

            <!-- Modal Footer -->
            <div class="flex flex-col sm:flex-row gap-3 p-6 border-t border-gray-200 bg-gray-50">
                @if (!Node.IsStart)
                {
                    <!-- Delete Button -->
                    @if (!showDeleteConfirmation)
                    {
                        <button type="button" 
                                @onclick="ShowDeleteConfirmation"
                                disabled="@isSaving"
                                class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-trash-fill"></i>
                            Usuń technologię
                        </button>
                    }
                    else
                    {
                        <div class="flex gap-2">
                            <button type="button" 
                                    @onclick="HandleDelete"
                                    disabled="@isSaving"
                                    class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="bi bi-check-lg"></i>
                                Potwierdź usunięcie
                            </button>
                            <button type="button" 
                                    @onclick="() => showDeleteConfirmation = false"
                                    disabled="@isSaving"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                Anuluj
                            </button>
                        </div>
                    }
                }

                <div class="flex-1"></div>

                <!-- Action Buttons -->
                <button type="button" 
                        @onclick="HandleGetRecommendations"
                        disabled="@isSaving"
                        class="inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-primary-700 bg-white border border-primary-700 rounded-lg hover:bg-primary-50 focus:ring-4 focus:outline-none focus:ring-primary-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="bi bi-stars"></i>
                    Szukaj nowych technologii
                </button>

                @if (!Node.IsStart)
                {
                    <button type="button" 
                            @onclick="HandleSave"
                            disabled="@isSaving"
                            class="inline-flex items-center justify-center gap-2 px-5 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        @if (isSaving)
                        {
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Zapisywanie...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-circle"></i>
                            <span>Zapisz zmiany</span>
                        }
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public GraphNodeDto? Node { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnSaved { get; set; }

    [Parameter]
    public EventCallback OnDeleted { get; set; }

    [Parameter]
    public EventCallback<int> OnGetRecommendations { get; set; }

    private int progress;
    private string? privateDescription;
    private bool isSaving = false;
    private bool showDeleteConfirmation = false;
    private string? errorMessage;
    private string? successMessage;

    protected override void OnParametersSet()
    {
        if (Node is not null && IsVisible)
        {
            // Zainicjalizuj wartości
            progress = Node.Progress;
            privateDescription = null; // TODO: Pobierz z API gdy będzie dostępne
            showDeleteConfirmation = false;
            errorMessage = null;
            successMessage = null;
        }
    }

    private async Task HandleSave()
    {
        if (Node is null || Node.IsStart)
            return;

        try
        {
            isSaving = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            var command = new UpdateTechnologyCommand
            {
                Progress = progress,
                PrivateDescription = privateDescription
            };

            var result = await TechnologyService.UpdateTechnologyAsync(Node.Id, command);

            if (result is not null)
            {
                successMessage = "Zmiany zostały zapisane!";
                Logger.LogInformation("Zaktualizowano technologię {NodeId}", Node.Id);
                
                // Poczekaj chwilę aby użytkownik zobaczył komunikat
                await Task.Delay(800);
                
                await OnSaved.InvokeAsync();
                await HandleClose();
            }
            else
            {
                errorMessage = "Nie udało się zapisać zmian. Spróbuj ponownie.";
                Logger.LogWarning("Nie udało się zaktualizować technologii {NodeId}", Node.Id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Błąd podczas zapisywania technologii {NodeId}", Node?.Id);
            errorMessage = "Wystąpił błąd podczas zapisywania. Spróbuj ponownie.";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task HandleDelete()
    {
        if (Node is null || Node.IsStart)
            return;

        try
        {
            isSaving = true;
            errorMessage = null;
            StateHasChanged();

            var result = await TechnologyService.DeleteTechnologyAsync(Node.Id);

            if (result is not null)
            {
                Logger.LogInformation("Usunięto technologię {NodeId}", Node.Id);
                await OnDeleted.InvokeAsync();
                await HandleClose();
            }
            else
            {
                errorMessage = "Nie udało się usunąć technologii. Spróbuj ponownie.";
                Logger.LogWarning("Nie udało się usunąć technologii {NodeId}", Node.Id);
                showDeleteConfirmation = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Błąd podczas usuwania technologii {NodeId}", Node?.Id);
            errorMessage = "Wystąpił błąd podczas usuwania. Spróbuj ponownie.";
            showDeleteConfirmation = false;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task HandleGetRecommendations()
    {
        if (Node is null)
            return;

        Logger.LogInformation("Otwieranie rekomendacji dla węzła {NodeId}", Node.Id);
        await OnGetRecommendations.InvokeAsync(Node.Id);
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteConfirmation = true;
        errorMessage = null;
        successMessage = null;
    }

    private async Task HandleClose()
    {
        showDeleteConfirmation = false;
        errorMessage = null;
        successMessage = null;
        await OnClose.InvokeAsync();
    }

    private void HandleOverlayClick()
    {
        // Zamknij modal gdy kliknięto overlay (tylko jeśli nie zapisuje)
        if (!isSaving)
        {
            _ = HandleClose();
        }
    }

    private string GetNodeColor(int progressValue)
    {
        if (progressValue == 0) return "#9ca3af";
        if (progressValue < 30) return "#ef4444";
        if (progressValue < 70) return "#f59e0b";
        if (progressValue < 100) return "#3b82f6";
        return "#10b981";
    }
}
